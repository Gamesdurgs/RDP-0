name: Ultimate Windows 11 RDP (Tailscale)
on: 
  workflow_dispatch: # Allows manual start

jobs:
  rdp-session:
    runs-on: windows-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: 1. Connect Tailscale
        shell: powershell
        env:
          TS_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          Write-Host "Installing and connecting Tailscale..."
          IEX (New-Object Net.WebClient).DownloadString('https://pkgs.tailscale.com/stable/install.ps1')
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=$env:TS_KEY --hostname="GitHub-Win11-RDP"
          Write-Host "Tailscale Connected!"

      - name: 2. Optimize Performance & Security
        shell: powershell
        run: |
          Write-Host "Disabling Defender and Updates to save CPU..."
          # Disable Windows Update
          Stop-Service -Name wuauserv -Force
          Set-Service -Name wuauserv -StartupType Disabled
          # Disable Defender
          Set-MpPreference -DisableRealtimeMonitoring $true
          # High Performance Power Plan
          powercfg /s 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c

      - name: 3. Configure RDP & User
        shell: powershell
        run: |
          Write-Host "Setting up RDP access..."
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          # Set the runneradmin password (using a simple one for this example)
          $Password = ConvertTo-SecureString "YourSecurePassword123!" -AsPlainText -Force
          Set-LocalUser -Name "runneradmin" -Password $Password

      - name: 4. Install Software & Set Startup
        shell: powershell
        run: |
          Write-Host "Installing VS Code and Chrome via Chocolatey..."
          choco install vscode googlechrome -y
          
          # Create Auto-Launch script
          $BatPath = "C:\Users\runneradmin\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\Launch.bat"
          $BatContent = "start code && start chrome https://github.com"
          Set-Content -Path $BatPath -Value $BatContent

      - name: 5. Keep Alive (6 Hours)
        shell: powershell
        run: |
          $IP = (& "C:\Program Files\Tailscale\tailscale.exe" ip -4)
          Write-Host "--- SETUP COMPLETE ---"
          Write-Host "Tailscale IP: $IP"
          Write-Host "Username: runneradmin"
          Write-Host "Password: YourSecurePassword123!"
          Write-Host "--- Connection will remain open for 6 hours ---"
          while ($true) { Start-Sleep -Seconds 60 }
          
