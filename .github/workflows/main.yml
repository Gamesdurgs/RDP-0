name: Roblox Remote Desktop (Tailscale)

on: 
  workflow_dispatch: # Manual trigger from the "Actions" tab

jobs:
  rdp-session:
    runs-on: windows-latest
    timeout-minutes: 360 # 6-hour GitHub limit

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Restore Studio Plugins & Settings
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: roblox-studio-settings
          path: ~\AppData\Local\Roblox\

      - name: Install Tailscale
        shell: powershell
        run: |
          iex ((New-Object System.Net.WebClient).DownloadString('https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe'))
          Start-Sleep -s 30

      - name: Connect to Tailscale
        shell: pwsh
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey $env:TAILSCALE_AUTH_KEY

      - name: Configure RDP & User
        shell: pwsh
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          $password = ConvertTo-SecureString "RobloxDev2026!" -AsPlainText -Force
          Set-LocalUser -Name "runneradmin" -Password $password

      - name: Pre-Download Roblox Studio
        shell: powershell
        run: |
          $dest = Join-Path ([System.IO.Path]::Combine($env:USERPROFILE, "Desktop")) "RobloxStudioLauncher.exe"
          Invoke-WebRequest -Uri "https://setup.rbxcdn.com/RobloxStudioLauncherBeta.exe" -OutFile $dest

      - name: Start Background Auto-Git Sync
        shell: pwsh
        run: |
          git config --global user.name "Roblox-CI-Bot"
          git config --global user.email "bot@github.com"
          Start-Job -ScriptBlock {
            while ($true) {
              if (git status --porcelain) {
                git add .
                git commit -m "Auto-save: $(Get-Date -Format 'HH:mm:ss')"
                git push origin main
              }
              Start-Sleep -Seconds 300
            }
          }

      - name: Live Connection & Keep Alive
        shell: pwsh
        run: |
          $ip = (& "C:\Program Files\Tailscale\tailscale.exe" ip -4)
          Write-Host "----------------------------------------------------" -ForegroundColor Green
          Write-Host "RDP ADDRESS: $ip" -ForegroundColor Cyan
          Write-Host "USERNAME: runneradmin" -ForegroundColor Cyan
          Write-Host "PASSWORD: RobloxDev2026!" -ForegroundColor Cyan
          Write-Host "----------------------------------------------------"
          # Wait 5h 50m to allow time for the final artifact upload
          Start-Sleep -Seconds 21000 

      - name: Archive Studio Settings (Cleanup)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: roblox-studio-settings
          path: |
            ~\AppData\Local\Roblox\InstalledPlugins
            ~\AppData\Local\Roblox\Plugins
            ~\AppData\Local\Roblox\*.xml
          retention-days: 5
